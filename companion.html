<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cloudy Companion Demo</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: transparent; /* allow window transparency to show through */
        user-select: none;
        -webkit-user-select: none;
        -webkit-app-region: no-drag;
        overflow: hidden;
      }
      #sketch-holder {
        position: absolute;
        inset: 0;
      }
      /* Minimal helper text */
      .hint {
        position: absolute;
        bottom: 14px;
        left: 14px;
        color: rgba(255,255,255,0.92);
        font-family: -apple-system, system-ui, 'Segoe UI', Roboto, Helvetica, Arial;
        font-size: 12px;
        background: rgba(0,0,0,0.25);
        padding: 6px 10px;
        border-radius: 10px;
        /* Avoid backdrop-filter to prevent compositor artifacts on transparent windows */
        /* backdrop-filter: blur(6px); */
        letter-spacing: 0.2px;
        opacity: 1;
        pointer-events: none;
        z-index: 5;
        transition: opacity 0.35s ease;
      }
    </style>
  </head>
  <body>
    <div id="sketch-holder"></div>
    <div class="hint" id="hint">Drag to doodle • Double-click to clear</div>

    <!-- p5.js from CDN (works in local file iframe) -->
    <script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.min.js"></script>
    <script>
      // Cloudy companion p5 sketch (prettier, smoother)
      let doodles = [];
      let currentStroke = null;
      let cloud = { cx: 0, cy: 0, w: 0, h: 0 };
      let puffs = [];
      let mouthState = 'smile';

      function setup() {
        const holder = document.getElementById('sketch-holder');
        const cnv = createCanvas(windowWidth, windowHeight);
        cnv.parent(holder);
        cnv.elt.style.background = 'transparent';
        // Use device pixel ratio for crisp edges on HiDPI displays
        pixelDensity(window.devicePixelRatio || 1);
        colorMode(HSB, 360, 100, 100, 255);
        strokeCap(ROUND);
        computeLayout();
        makePuffs();
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
        computeLayout();
        makePuffs();
      }

      function computeLayout() {
        cloud.w = min(width, height) * 0.58;
        cloud.h = cloud.w * 0.62;
        cloud.cx = width * 0.5;
        cloud.cy = height * 0.5;
      }

      function makePuffs() {
        // Deterministic, symmetric puffs for a cute, iconic cloud shape
        puffs = [];
        // Top row (left → right)
        puffs.push(
          { ox: -0.42, oy: -0.02, sx: 0.44, sy: 0.54, a: 230 },
          { ox: -0.26, oy: -0.06, sx: 0.52, sy: 0.58, a: 235 },
          { ox: -0.10, oy: -0.10, sx: 0.56, sy: 0.60, a: 240 },
          { ox:  0.00, oy: -0.12, sx: 0.62, sy: 0.62, a: 240 },
          { ox:  0.10, oy: -0.10, sx: 0.56, sy: 0.60, a: 240 },
          { ox:  0.26, oy: -0.06, sx: 0.52, sy: 0.58, a: 235 },
          { ox:  0.42, oy: -0.02, sx: 0.44, sy: 0.54, a: 230 }
        );
        // Side puffs
        puffs.push(
          { ox: -0.55, oy: 0.06, sx: 0.36, sy: 0.44, a: 210 },
          { ox:  0.55, oy: 0.06, sx: 0.36, sy: 0.44, a: 210 }
        );
        // Bottom scallops
        puffs.push(
          { ox: -0.24, oy: 0.20, sx: 0.46, sy: 0.48, a: 205 },
          { ox:  0.24, oy: 0.20, sx: 0.46, sy: 0.48, a: 205 }
        );
      }

      function draw() {
        clear(); // transparent background

        // Draw doodles behind the cloud
        if (doodles.length || currentStroke) {
          noFill();
          for (let s of doodles) {
            stroke(s.color || color(20, 0, 100, 200));
            strokeWeight(s.weight || 3);
            beginShape();
            for (let p of s.points) vertex(p.x, p.y);
            endShape();
          }
          if (currentStroke) {
            stroke(currentStroke.color);
            strokeWeight(currentStroke.weight);
            beginShape();
            for (let p of currentStroke.points) vertex(p.x, p.y);
            endShape();
          }
        }

        // Gentle idle bobbing
        const t = frameCount * 0.02;
        const bob = sin(t) * (cloud.h * 0.02);
        const cx = cloud.cx;
        const cy = cloud.cy + bob;
        const w = cloud.w;
        const h = cloud.h;

        // Soft base shadow
        noStroke();
        fill(0, 0, 0, 28);
        ellipse(cx, cy + h * 0.49, w * 0.62, h * 0.25);

        // Cloud body
        drawCloud(cx, cy, w, h);

        // Eyes
        const eyeOffsetX = w * 0.19;
        const eyeOffsetY = -h * 0.03;
        const leftEye = { x: cx - eyeOffsetX, y: cy + eyeOffsetY };
        const rightEye = { x: cx + eyeOffsetX, y: cy + eyeOffsetY };
        const eyeR = w * 0.085;
        const pupilR = eyeR * 0.45;

        // Eyes (simple dots)
        noStroke();
        fill(0, 0, 20, 255);
        ellipse(leftEye.x, leftEye.y, pupilR * 2, pupilR * 2);
        ellipse(rightEye.x, rightEye.y, pupilR * 2, pupilR * 2);

        // Mouth: smile or surprised "o"
        if (mouthState === 'surprised') {
          fill(0, 0, 20, 240);
          const r = min(w, h) * 0.05;
          ellipse(cx, cy + h * 0.10, r * 2, r * 2);
        } else {
          stroke(0, 0, 20, 240);
          strokeWeight(max(1.6, w * 0.012));
          noFill();
          arc(cx, cy + h * 0.09, w * 0.12, h * 0.10, 0, PI);
        }
      }

      function drawCloud(x, y, w, h) {
        noStroke();
        // Soft main belly (horizontal)
        fill(0, 0, 100, 240);
        ellipse(x, y + h * 0.02, w * 0.82, h * 0.76);
        // Puffy parts
        for (let p of puffs) {
          fill(0, 0, 100, p.a);
          ellipse(x + p.ox * w, y + p.oy * h, w * p.sx, h * p.sy);
        }
        // Subtle highlight to mimic glossy puff
        fill(0, 0, 100, 40);
        ellipse(x - w * 0.18, y - h * 0.10, w * 0.32, h * 0.24);
      }

      // No pupil tracking — keep it simple and iconic

      function mousePressed() {
        const hue = (frameCount * 2) % 360;
        currentStroke = { color: color(hue, 35, 100, 210), weight: 3, points: [] };
        currentStroke.points.push({ x: mouseX, y: mouseY });
        hideHint();
        // Surprise mouth when clicking on the face region
        const dx = mouseX - cloud.cx;
        const dy = mouseY - cloud.cy;
        const faceW = cloud.w * 0.45;
        const faceH = cloud.h * 0.35;
        if (abs(dx) < faceW && abs(dy) < faceH) {
          mouthState = 'surprised';
          setTimeout(() => { mouthState = 'smile'; }, 380);
        }
      }

      function mouseDragged() {
        if (!currentStroke) return;
        currentStroke.points.push({ x: mouseX, y: mouseY });
      }

      function mouseReleased() {
        if (currentStroke && currentStroke.points.length > 1) {
          doodles.push(currentStroke);
        }
        currentStroke = null;
      }

      function doubleClicked() {
        doodles = [];
        return false;
      }

      function keyPressed() {
        if (key === 'c' || key === 'C') {
          doodles = [];
        }
      }
      // Hint hide after 8 seconds or on first interaction
      function hideHint() {
        const h = document.getElementById('hint');
        if (!h || h.dataset.hidden === '1') return;
        h.style.opacity = 0;
        h.dataset.hidden = '1';
        setTimeout(() => { if (h) h.style.display = 'none'; }, 400);
      }
      setTimeout(hideHint, 8000);
    </script>
  </body>
</html>
